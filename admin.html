<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administrador</title>

  <!-- ✅ Padrão do cliente -->
  <link rel="icon" type="image/png" href="/imagens/logo.png">

  <!-- Fonts (premium) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ✅ DESIGN/ESTRUTURA IGUAL AO PADRÃO -->
  <style>
    :root{
      --bg0:#071028;
      --bg1:#0b1f3f;
      --bg2:#0a2f4a;
      --bg3:#113a3f;

      --card: rgba(255,255,255,.085);
      --card2: rgba(255,255,255,.06);
      --glass: rgba(255,255,255,.05);
      --line: rgba(255,255,255,.18);

      --text:#f7f7ff;
      --muted:#d7dde8;

      --gold:#fbbf24;
      --gold2:#f97316;
      --red:#ef4444;
      --red2:#dc2626;
      --teal:#06b6d4;
      --blue:#2563eb;

      --ok:#22c55e;
      --bad:#fb7185;

      --radius: 22px;
      --shadow: 0 24px 70px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 520px at 14% 10%, rgba(239,68,68,.18), transparent 58%),
        radial-gradient(900px 520px at 88% 12%, rgba(6,182,212,.18), transparent 60%),
        radial-gradient(900px 520px at 70% 92%, rgba(251,191,36,.16), transparent 62%),
        radial-gradient(800px 520px at 18% 92%, rgba(249,115,22,.14), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 48%, var(--bg3));
      background-attachment: fixed;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 25% 25%, rgba(255,255,255,.05) 0 1px, transparent 2px),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,.04) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 75%, rgba(255,255,255,.03) 0 1px, transparent 2px);
      background-size: 240px 240px, 300px 300px, 360px 360px;
      opacity:.33;
      mix-blend-mode: overlay;
    }

    a{ color:inherit; text-decoration:none }
    .container{ max-width:1180px; margin:0 auto; padding:26px }
    @media (max-width:520px){ .container{ padding:16px } }

    /* ===== Topbar (ultra) ===== */
    .topbar{
      position:relative;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:16px 18px;
      border:1px solid var(--line);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar:after{
      content:"";
      position:absolute;
      inset:-60% -60%;
      background:
        linear-gradient(110deg,
          transparent 0%,
          rgba(239,68,68,.14) 30%,
          rgba(6,182,212,.14) 45%,
          rgba(251,191,36,.14) 58%,
          rgba(249,115,22,.12) 66%,
          transparent 78%
        );
      transform: translateX(-40%);
      animation: sweep 7.5s linear infinite;
      pointer-events:none;
      opacity:.95;
    }
    @keyframes sweep{
      0%{ transform: translateX(-50%) rotate(0.001deg); }
      100%{ transform: translateX(50%) rotate(0.001deg); }
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; z-index:1; }
    .brand img{
      height:80px;
      width:auto;
      object-fit:contain;
      border:none;
      background:transparent;
      filter: drop-shadow(0 0 14px rgba(239,68,68,.25))
              drop-shadow(0 0 18px rgba(251,191,36,.22))
              drop-shadow(0 0 16px rgba(6,182,212,.18));
    }
    .titles{ min-width:0 }
    .titles .name{
      font-family:"Playfair Display", serif;
      font-weight:800;
      letter-spacing:.7px;
      font-size:20px;
      line-height:1.1;
      background: linear-gradient(90deg, var(--gold), rgba(255,255,255,.98), var(--red));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      text-shadow: 0 0 18px rgba(251,191,36,.14);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .titles .sub{
      margin-top:2px;
      font-size:12px;
      color:rgba(215,221,232,.94);
      letter-spacing:.2px;
    }

    .navlinks{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; z-index:1 }

    /* ===== Buttons ===== */
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color:var(--text);
      padding:11px 14px;
      border-radius: 16px;
      transition: transform .12s ease, box-shadow .25s ease, border-color .25s ease, filter .25s ease;
      box-shadow: 0 14px 34px rgba(0,0,0,.25);
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btn:hover{
      transform: translateY(-2px);
      border-color: rgba(239,68,68,.28);
      box-shadow: 0 18px 44px rgba(0,0,0,.32), 0 0 0 3px rgba(239,68,68,.10) inset;
    }
    .btn:active{ transform: translateY(0px) scale(.99) }

    .btn.secondary{
      border:none;
      background: linear-gradient(90deg, rgba(6,182,212,.96), rgba(37,99,235,.92));
      box-shadow:
        0 18px 44px rgba(0,0,0,.30),
        0 0 26px rgba(6,182,212,.14),
        0 0 22px rgba(37,99,235,.12);
    }
    .btn.secondary:hover{
      filter: brightness(1.03);
      box-shadow:
        0 22px 54px rgba(0,0,0,.34),
        0 0 34px rgba(6,182,212,.16),
        0 0 30px rgba(37,99,235,.14);
    }

    .btn.primary{
      border:none;
      color:#140c2a;
      background: linear-gradient(90deg, var(--gold), var(--gold2));
      box-shadow:
        0 18px 44px rgba(0,0,0,.30),
        0 0 28px rgba(251,191,36,.18);
      position:relative;
      overflow:hidden;
    }
    .btn.primary:after{
      content:"";
      position:absolute;
      inset:-40% -40%;
      background: linear-gradient(110deg, transparent 25%, rgba(255,255,255,.35) 45%, transparent 65%);
      transform: translateX(-60%);
      animation: shine 2.8s ease-in-out infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes shine{
      0%{ transform: translateX(-65%); }
      55%{ transform: translateX(65%); }
      100%{ transform: translateX(65%); }
    }

    .btn.danger{
      border-color: rgba(251,113,133,.26);
      background: rgba(251,113,133,.10);
    }

    /* ===== Layout ===== */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1.1fr .9fr;
      margin-top:16px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr }
      .navlinks{ justify-content:flex-start }
    }
    @media (max-width:520px){
      .topbar{ flex-direction:column; align-items:stretch }
      .navlinks{ justify-content:flex-start }
      .btn{ width:100%; justify-content:center }
    }

    .card{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      backdrop-filter: blur(18px);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding:20px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 26px;
      padding:1px;
      background:
        linear-gradient(120deg,
          rgba(239,68,68,.22),
          rgba(6,182,212,.16),
          rgba(251,191,36,.16),
          rgba(255,255,255,.06)
        );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity:.62;
    }

    .card h2{
      margin:0 0 8px 0;
      font-family:"Playfair Display", serif;
      font-size:22px;
      letter-spacing:.2px;
    }

    .muted{ color:rgba(215,221,232,.92) }
    .small{ font-size:12px }
    .hr{ height:1px; background:rgba(255,255,255,.12); margin:14px 0 }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end }

    .field{ display:flex; flex-direction:column; gap:7px; margin:10px 0; flex:1; min-width:220px }
    label{ font-size:12px; color:rgba(215,221,232,.92); letter-spacing:.2px }

    .input, select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      box-shadow: 0 10px 28px rgba(0,0,0,.18) inset;
    }
    .input::placeholder{ color:rgba(215,221,232,.72) }
    .input:focus, select:focus{
      border-color: rgba(251,191,36,.60);
      box-shadow: 0 0 0 3px rgba(251,191,36,.14), 0 14px 34px rgba(0,0,0,.22) inset;
    }

    .list{ display:flex; flex-direction:column; gap:10px }
    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:14px;
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 44px rgba(0,0,0,.24);
    }
    .item .top{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start }
    .item .title{ font-weight:800; letter-spacing:.15px }

    /* Toast (padrão) */
    .toast{
      position:fixed; right:18px; bottom:18px; max-width:min(420px, calc(100vw - 36px));
      padding:12px 14px; border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(300px 160px at 20% 20%, rgba(239,68,68,.16), transparent 55%),
        radial-gradient(300px 160px at 85% 25%, rgba(6,182,212,.14), transparent 58%),
        radial-gradient(300px 160px at 65% 90%, rgba(251,191,36,.14), transparent 60%),
        rgba(255,255,255,.07);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      display:none;
      z-index:9999;
      font-weight:800;
      letter-spacing:.2px;
    }
    .toast.show{ display:block }

    html{ scroll-behavior:smooth; }
  </style>
</head>

<body>
  <div class="container">
    <!-- ✅ TOPBAR PADRÃO -->
    <div class="topbar">
      <div class="brand">
        <img src="/imagens/logo.png" alt="Barbearia Las Vegas Logo">
        <div class="titles">
          <div class="name" id="brandName">Barbearia Las Vegas</div>
          <div class="sub">Portal do Administrador</div>
        </div>
      </div>

      <div class="navlinks">
        <a class="btn" href="../">Cliente</a>
        <a class="btn secondary" href="../barbeiro/">Barbeiro</a>
        <button class="btn danger" id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="loginCard">
        <h2>Entrar (Admin)</h2>
        <div class="muted small">Login via Supabase Auth (email/senha).</div>

        <div class="field">
          <label>Email</label>
          <input class="input" id="email" placeholder="admin@exemplo.com">
        </div>
        <div class="field">
          <label>Senha</label>
          <input class="input" id="password" type="password" placeholder="••••••••">
        </div>

        <!-- ✅ Mantive seu botão, só no estilo padrão -->
        <button class="btn secondary" id="loginBtn">Entrar</button>

        <div class="hr"></div>
        <div class="muted small">
          Se esse for seu primeiro admin: crie um usuário em <b>Authentication → Users</b> e depois
          insira ele na tabela <b>lv_staff</b> com role=admin (vou te explicar no passo a passo).
        </div>
      </div>

      <div class="card" id="panelCard" style="display:none">
        <h2>Configurações</h2>

        <div class="row">
          <div class="field">
            <label>Nome exibido</label>
            <input class="input" id="brandInput" placeholder="Barbearia Las Vegas">
          </div>
          <div class="field">
            <label>Intervalo (min)</label>
            <input class="input" id="slotInterval" type="number" min="5" step="5">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Antecedência mínima (min)</label>
            <input class="input" id="minAdvance" type="number" min="0" step="10">
          </div>
          <div class="field">
            <label>Prazo de cancelamento (min)</label>
            <input class="input" id="cancelLimit" type="number" min="0" step="30">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Máx. dias à frente</label>
            <input class="input" id="maxDays" type="number" min="1" step="1">
          </div>
          <div class="field" style="align-self:end">
            <button class="btn secondary" id="saveConfig">Salvar</button>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Serviços</h2>
        <div class="row">
          <div class="field"><label>Nome</label><input class="input" id="svcName" placeholder="Corte"></div>
          <div class="field"><label>Duração (min)</label><input class="input" id="svcDur" type="number" min="5" step="5" value="30"></div>
          <div class="field"><label>Preço (R$)</label><input class="input" id="svcPrice" type="number" min="0" step="1" value="40"></div>
          <div class="field" style="align-self:end"><button class="btn secondary" id="addSvc">Adicionar</button></div>
        </div>
        <div id="svcList" class="list"></div>

        <div class="hr"></div>

        <h2>Barbeiros (Auth real)</h2>
        <div class="muted small">
          O admin cria o barbeiro com <b>email + senha</b>. Ele vai logar no portal do barbeiro com esses dados.
        </div>

        <div class="row">
          <div class="field"><label>Nome do barbeiro</label><input class="input" id="brbName" placeholder="Matheus"></div>
          <div class="field"><label>Email do barbeiro</label><input class="input" id="brbEmail" placeholder="matheus@exemplo.com"></div>
          <div class="field"><label>Senha (>= 6)</label><input class="input" id="brbPass" placeholder="senha123"></div>
          <div class="field" style="align-self:end"><button class="btn secondary" id="addBarber">Criar barbeiro</button></div>
        </div>

        <div id="brbList" class="list"></div>

        <div class="hr"></div>

        <h2>Horários</h2>
        <div id="hoursGrid" class="list"></div>
        <button class="btn secondary" id="saveHours">Salvar horários</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ✅ NÃO MEXI NO JS/SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dpvgcjzsigaqnqainmro.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_931ojZ41L4aq-rctZFIFuw_-3qCo1qB";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LV = {
      toast(msg){
        const el = document.querySelector("#toast");
        el.textContent = msg;
        el.classList.add("show");
        setTimeout(()=>el.classList.remove("show"), 2600);
      },
      uid(prefix=""){
        const r = Math.random().toString(36).slice(2, 8).toUpperCase();
        const t = Date.now().toString(36).toUpperCase().slice(-4);
        return (prefix + r + t).slice(0, 12);
      },
      toMin(hhmm){
        const [h,m]=String(hhmm).split(":").map(Number);
        return h*60+(m||0);
      }
    };

    const loginCard = document.querySelector("#loginCard");
    const panelCard = document.querySelector("#panelCard");
    const logoutBtn = document.querySelector("#logoutBtn");

    const brandName = document.querySelector("#brandName");
    const email = document.querySelector("#email");
    const password = document.querySelector("#password");
    const loginBtn = document.querySelector("#loginBtn");

    const brandInput = document.querySelector("#brandInput");
    const slotInterval = document.querySelector("#slotInterval");
    const minAdvance = document.querySelector("#minAdvance");
    const cancelLimit = document.querySelector("#cancelLimit");
    const maxDays = document.querySelector("#maxDays");
    const saveConfig = document.querySelector("#saveConfig");

    const svcName = document.querySelector("#svcName");
    const svcDur = document.querySelector("#svcDur");
    const svcPrice = document.querySelector("#svcPrice");
    const addSvc = document.querySelector("#addSvc");
    const svcList = document.querySelector("#svcList");

    const brbName = document.querySelector("#brbName");
    const brbEmail = document.querySelector("#brbEmail");
    const brbPass = document.querySelector("#brbPass");
    const addBarber = document.querySelector("#addBarber");
    const brbList = document.querySelector("#brbList");

    const hoursGrid = document.querySelector("#hoursGrid");
    const saveHours = document.querySelector("#saveHours");

    const dayNames = ["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"];

    async function isAdmin(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user) return false;
      const { data } = await sb.from("lv_staff").select("role").eq("user_id", user.id).maybeSingle();
      return !!data && data.role === "admin";
    }

    async function renderAuth(){
      const { data: { session } } = await sb.auth.getSession();
      const ok = !!session;
      loginCard.style.display = ok ? "none" : "block";
      panelCard.style.display = ok ? "block" : "none";
      logoutBtn.style.display = ok ? "inline-flex" : "none";
      if(!ok) return;

      const admin = await isAdmin();
      if(!admin){
        await sb.auth.signOut();
        LV.toast("Sem permissão de admin.");
        return;
      }
      await loadAll();
    }

    async function loadAll(){
      const cfg = await sb.from("lv_config").select("*").eq("id",1).maybeSingle();
      const cfgRow = cfg.data || null;

      brandName.textContent = cfgRow?.brand_name || "Barbearia Las Vegas";
      brandInput.value = cfgRow?.brand_name || "Barbearia Las Vegas";
      slotInterval.value = cfgRow?.slot_interval_min ?? 10;
      minAdvance.value = cfgRow?.min_advance_min ?? 60;
      cancelLimit.value = cfgRow?.cancel_limit_min ?? 180;
      maxDays.value = cfgRow?.max_days_ahead ?? 14;

      await renderServices();
      await renderBarbers();
      await renderHours();
    }

    async function login(){
      const e = (email.value||"").trim();
      const p = (password.value||"").trim();
      if(!e || !p) return LV.toast("Digite email e senha.");
      const { error } = await sb.auth.signInWithPassword({ email: e, password: p });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Entrou!");
      await renderAuth();
    }

    async function logout(){
      await sb.auth.signOut();
      LV.toast("Saiu.");
      await renderAuth();
    }

    async function saveCfg(){
      const payload = {
        id: 1,
        brand_name: (brandInput.value||"").trim() || "Barbearia Las Vegas",
        slot_interval_min: Number(slotInterval.value||10),
        min_advance_min: Number(minAdvance.value||60),
        cancel_limit_min: Number(cancelLimit.value||180),
        max_days_ahead: Number(maxDays.value||14),
        updated_at: new Date().toISOString()
      };
      const { error } = await sb.from("lv_config").upsert(payload, { onConflict:"id" });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Config salva!");
      await loadAll();
    }

    async function renderServices(){
      const { data } = await sb.from("lv_services").select("*").order("created_at",{ascending:true});
      svcList.innerHTML = "";
      for(const s of (data||[])){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${s.name}</div>
              <div class="muted small">ID: ${s.id} • ${s.duration_min}min • ${s.price==null?"—":"R$ "+Number(s.price).toFixed(2).replace(".",",")} • ${s.active? "Ativo":"Inativo"}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="toggle">${s.active? "Inativar":"Ativar"}</button>
              <button class="btn danger" data-act="del">Remover</button>
            </div>
          </div>
        `;
        div.querySelector('[data-act="toggle"]').onclick = async ()=>{
          await sb.from("lv_services").update({ active: !s.active }).eq("id", s.id);
          LV.toast("Atualizado.");
          await renderServices();
        };
        div.querySelector('[data-act="del"]').onclick = async ()=>{
          await sb.from("lv_services").delete().eq("id", s.id);
          LV.toast("Removido.");
          await renderServices();
        };
        svcList.appendChild(div);
      }
    }

    async function addService(){
      const name = (svcName.value||"").trim();
      const dur = Math.max(5, Number(svcDur.value||30));
      const priceRaw = (svcPrice.value||"").trim();
      const price = priceRaw==="" ? null : Math.max(0, Number(priceRaw));
      if(name.length < 2) return LV.toast("Nome inválido.");
      const id = LV.uid("SVC_");
      const { error } = await sb.from("lv_services").insert({ id, name, duration_min: dur, price, active:true });
      if(error) return LV.toast("Erro: " + error.message);
      svcName.value="";
      LV.toast("Serviço criado.");
      await renderServices();
    }

    async function renderBarbers(){
      const { data } = await sb.from("lv_barbers").select("*").order("created_at",{ascending:true});
      brbList.innerHTML = "";
      for(const b of (data||[])){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${b.name}</div>
              <div class="muted small">ID: ${b.id} • ${b.active? "Ativo":"Inativo"}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="toggle">${b.active? "Inativar":"Ativar"}</button>
            </div>
          </div>
        `;
        div.querySelector('[data-act="toggle"]').onclick = async ()=>{
          await sb.from("lv_barbers").update({ active: !b.active }).eq("id", b.id);
          LV.toast("Atualizado.");
          await renderBarbers();
        };
        brbList.appendChild(div);
      }
    }

    async function createBarberAuth(){
      const name = (brbName.value||"").trim();
      const em = (brbEmail.value||"").trim().toLowerCase();
      const pw = (brbPass.value||"").trim();
      if(name.length < 2) return LV.toast("Nome inválido.");
      if(!em.includes("@")) return LV.toast("Email inválido.");
      if(pw.length < 6) return LV.toast("Senha precisa ter 6+.");

      const barberId = LV.uid("BRB_");

      const { data: { session } } = await sb.auth.getSession();
      if(!session) return LV.toast("Faça login.");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/create-staff-user`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({
          role: "barber",
          email: em,
          password: pw,
          barber_id: barberId,
          barber_name: name
        })
      });

      const out = await res.json();
      if(!res.ok) return LV.toast("Erro: " + (out.error || "falha"));
      LV.toast("Barbeiro criado! Envie email/senha pra ele.");
      brbName.value=""; brbEmail.value=""; brbPass.value="";
      await renderBarbers();
    }

    async function renderHours(){
      const { data } = await sb.from("lv_hours").select("*").order("weekday",{ascending:true});
      const map = new Map((data||[]).map(r=>[Number(r.weekday), r]));
      hoursGrid.innerHTML = "";

      for(let i=0;i<7;i++){
        const h = map.get(i) || { weekday:i, open:false, start_time:"09:00", end_time:"18:00" };
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${dayNames[i]}</div>
              <div class="muted small">Abre? e horários</div>
            </div>
          </div>
          <div class="row">
            <label class="muted small" style="min-width:120px">
              <input type="checkbox" data-day="${i}" data-k="open" ${h.open?"checked":""}>
              Aberto
            </label>
            <div class="field" style="min-width:160px">
              <label>Início</label>
              <input class="input" type="time" data-day="${i}" data-k="start_time" value="${h.start_time}">
            </div>
            <div class="field" style="min-width:160px">
              <label>Fim</label>
              <input class="input" type="time" data-day="${i}" data-k="end_time" value="${h.end_time}">
            </div>
          </div>
        `;
        hoursGrid.appendChild(div);
      }
    }

    async function saveHoursNow(){
      const els = hoursGrid.querySelectorAll("[data-day]");
      const rows = [];
      for(const el of els){
        const day = Number(el.getAttribute("data-day"));
        const k = el.getAttribute("data-k");
        let r = rows.find(x=>x.weekday===day);
        if(!r){ r={weekday:day, open:false, start_time:"09:00", end_time:"18:00"}; rows.push(r); }
        if(k==="open") r.open = el.checked;
        else r[k] = el.value || r[k];
      }

      for(const r of rows){
        if(r.open){
          const a = LV.toMin(r.start_time), b = LV.toMin(r.end_time);
          if(!(a < b)) return LV.toast(`Horário inválido em ${dayNames[r.weekday]}`);
        }
      }

      const { error } = await sb.from("lv_hours").upsert(rows, { onConflict:"weekday" });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Horários salvos!");
      await renderHours();
    }

    loginBtn.onclick = login;
    password.addEventListener("keyup",(e)=>{ if(e.key==="Enter") login(); });
    logoutBtn.onclick = logout;

    saveConfig.onclick = saveCfg;
    addSvc.onclick = addService;
    addBarber.onclick = createBarberAuth;
    saveHours.onclick = saveHoursNow;

    sb.auth.onAuthStateChange(renderAuth);
    renderAuth();
  </script>
</body>
</html>
