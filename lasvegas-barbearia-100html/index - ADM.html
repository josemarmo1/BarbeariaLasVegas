<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin • Barbearia Las Vegas</title>
  <link rel="icon" href="../assets/logo.png">
  <style>
    /* mantém seu CSS (resumido aqui pra não explodir) */
    :root{--bg:#0b0c10;--panel:#12141b;--panel2:#171a22;--text:#f5f7ff;--muted:#aab0c0;--brand:#ffd166;--ok:#2dd4bf;--bad:#fb7185;--line:rgba(255,255,255,.08);--shadow:0 18px 60px rgba(0,0,0,.55);--radius:18px;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);font-family:system-ui;background:linear-gradient(180deg,#07080c,#0b0c10 30%,#0b0c10);}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 16px;border:1px solid var(--line);background:rgba(18,20,27,.65);backdrop-filter: blur(10px);border-radius: var(--radius);box-shadow: var(--shadow);}
    .brand{display:flex;align-items:center;gap:12px;min-width:0;}
    .brand img{height:44px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .brand .name{font-weight:800}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .navlinks{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{cursor:pointer;border:1px solid var(--line);background:rgba(23,26,34,.6);color:var(--text);padding:10px 12px;border-radius:14px;user-select:none}
    .btn.ok{background:rgba(45,212,191,.10)}
    .btn.danger{background:rgba(251,113,133,.10)}
    .grid{display:grid;gap:16px;grid-template-columns: 1.1fr .9fr;margin-top:18px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{border:1px solid var(--line);background:rgba(18,20,27,.55);backdrop-filter: blur(10px);border-radius: var(--radius);box-shadow: var(--shadow);padding:16px;}
    .muted{color:var(--muted)} .small{font-size:12px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0;flex:1;min-width:220px}
    label{font-size:12px;color:var(--muted)}
    .input, select{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(23,26,34,.7);color:var(--text);outline:none}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(23,26,34,.55)}
    .item .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .item .title{font-weight:750}
    .toast{position:fixed;right:18px;bottom:18px;max-width:min(420px, calc(100vw - 36px));padding:12px 14px;border-radius:16px;border:1px solid var(--line);background:rgba(18,20,27,.82);backdrop-filter: blur(10px);box-shadow: var(--shadow);display:none;}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <img src="../assets/logo.png" alt="Logo">
        <div>
          <div class="name" id="brandName">Barbearia Las Vegas</div>
          <div class="sub">Admin • Supabase Auth + Edge Function</div>
        </div>
      </div>
      <div class="navlinks">
        <a class="btn" href="../">Cliente</a>
        <a class="btn" href="../barbeiro/">Barbeiro</a>
        <button class="btn danger" id="logoutBtn" style="display:none">Sair</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="loginCard">
        <h2>Entrar (Admin)</h2>
        <div class="muted small">Login via Supabase Auth (email/senha).</div>

        <div class="field">
          <label>Email</label>
          <input class="input" id="email" placeholder="admin@exemplo.com">
        </div>
        <div class="field">
          <label>Senha</label>
          <input class="input" id="password" type="password" placeholder="••••••••">
        </div>
        <button class="btn ok" id="loginBtn">Entrar</button>

        <div class="hr"></div>
        <div class="muted small">
          Se esse for seu primeiro admin: crie um usuário em <b>Authentication → Users</b> e depois
          insira ele na tabela <b>lv_staff</b> com role=admin (vou te explicar no passo a passo).
        </div>
      </div>

      <div class="card" id="panelCard" style="display:none">
        <h2>Configurações</h2>

        <div class="row">
          <div class="field">
            <label>Nome exibido</label>
            <input class="input" id="brandInput" placeholder="Barbearia Las Vegas">
          </div>
          <div class="field">
            <label>Intervalo (min)</label>
            <input class="input" id="slotInterval" type="number" min="5" step="5">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Antecedência mínima (min)</label>
            <input class="input" id="minAdvance" type="number" min="0" step="10">
          </div>
          <div class="field">
            <label>Prazo de cancelamento (min)</label>
            <input class="input" id="cancelLimit" type="number" min="0" step="30">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Máx. dias à frente</label>
            <input class="input" id="maxDays" type="number" min="1" step="1">
          </div>
          <div class="field" style="align-self:end">
            <button class="btn ok" id="saveConfig">Salvar</button>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Serviços</h2>
        <div class="row">
          <div class="field"><label>Nome</label><input class="input" id="svcName" placeholder="Corte"></div>
          <div class="field"><label>Duração (min)</label><input class="input" id="svcDur" type="number" min="5" step="5" value="30"></div>
          <div class="field"><label>Preço (R$)</label><input class="input" id="svcPrice" type="number" min="0" step="1" value="40"></div>
          <div class="field" style="align-self:end"><button class="btn ok" id="addSvc">Adicionar</button></div>
        </div>
        <div id="svcList" class="list"></div>

        <div class="hr"></div>

        <h2>Barbeiros (Auth real)</h2>
        <div class="muted small">
          O admin cria o barbeiro com <b>email + senha</b>. Ele vai logar no portal do barbeiro com esses dados.
        </div>

        <div class="row">
          <div class="field"><label>Nome do barbeiro</label><input class="input" id="brbName" placeholder="Matheus"></div>
          <div class="field"><label>Email do barbeiro</label><input class="input" id="brbEmail" placeholder="matheus@exemplo.com"></div>
          <div class="field"><label>Senha (>= 6)</label><input class="input" id="brbPass" placeholder="senha123"></div>
          <div class="field" style="align-self:end"><button class="btn ok" id="addBarber">Criar barbeiro</button></div>
        </div>

        <div id="brbList" class="list"></div>

        <div class="hr"></div>

        <h2>Horários</h2>
        <div id="hoursGrid" class="list"></div>
        <button class="btn ok" id="saveHours">Salvar horários</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dpvgcjzsigaqnqainmro.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_931ojZ41L4aq-rctZFIFuw_-3qCo1qB";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LV = {
      toast(msg){
        const el = document.querySelector("#toast");
        el.textContent = msg;
        el.classList.add("show");
        setTimeout(()=>el.classList.remove("show"), 2600);
      },
      uid(prefix=""){
        const r = Math.random().toString(36).slice(2, 8).toUpperCase();
        const t = Date.now().toString(36).toUpperCase().slice(-4);
        return (prefix + r + t).slice(0, 12);
      },
      toMin(hhmm){
        const [h,m]=String(hhmm).split(":").map(Number);
        return h*60+(m||0);
      }
    };

    const loginCard = document.querySelector("#loginCard");
    const panelCard = document.querySelector("#panelCard");
    const logoutBtn = document.querySelector("#logoutBtn");

    const brandName = document.querySelector("#brandName");
    const email = document.querySelector("#email");
    const password = document.querySelector("#password");
    const loginBtn = document.querySelector("#loginBtn");

    const brandInput = document.querySelector("#brandInput");
    const slotInterval = document.querySelector("#slotInterval");
    const minAdvance = document.querySelector("#minAdvance");
    const cancelLimit = document.querySelector("#cancelLimit");
    const maxDays = document.querySelector("#maxDays");
    const saveConfig = document.querySelector("#saveConfig");

    const svcName = document.querySelector("#svcName");
    const svcDur = document.querySelector("#svcDur");
    const svcPrice = document.querySelector("#svcPrice");
    const addSvc = document.querySelector("#addSvc");
    const svcList = document.querySelector("#svcList");

    const brbName = document.querySelector("#brbName");
    const brbEmail = document.querySelector("#brbEmail");
    const brbPass = document.querySelector("#brbPass");
    const addBarber = document.querySelector("#addBarber");
    const brbList = document.querySelector("#brbList");

    const hoursGrid = document.querySelector("#hoursGrid");
    const saveHours = document.querySelector("#saveHours");

    const dayNames = ["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"];

    async function isAdmin(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user) return false;
      const { data } = await sb.from("lv_staff").select("role").eq("user_id", user.id).maybeSingle();
      return !!data && data.role === "admin";
    }

    async function renderAuth(){
      const { data: { session } } = await sb.auth.getSession();
      const ok = !!session;
      loginCard.style.display = ok ? "none" : "block";
      panelCard.style.display = ok ? "block" : "none";
      logoutBtn.style.display = ok ? "inline-flex" : "none";
      if(!ok) return;

      const admin = await isAdmin();
      if(!admin){
        await sb.auth.signOut();
        LV.toast("Sem permissão de admin.");
        return;
      }
      await loadAll();
    }

    async function loadAll(){
      const cfg = await sb.from("lv_config").select("*").eq("id",1).maybeSingle();
      const cfgRow = cfg.data || null;

      brandName.textContent = cfgRow?.brand_name || "Barbearia Las Vegas";
      brandInput.value = cfgRow?.brand_name || "Barbearia Las Vegas";
      slotInterval.value = cfgRow?.slot_interval_min ?? 10;
      minAdvance.value = cfgRow?.min_advance_min ?? 60;
      cancelLimit.value = cfgRow?.cancel_limit_min ?? 180;
      maxDays.value = cfgRow?.max_days_ahead ?? 14;

      await renderServices();
      await renderBarbers();
      await renderHours();
    }

    async function login(){
      const e = (email.value||"").trim();
      const p = (password.value||"").trim();
      if(!e || !p) return LV.toast("Digite email e senha.");
      const { error } = await sb.auth.signInWithPassword({ email: e, password: p });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Entrou!");
      await renderAuth();
    }

    async function logout(){
      await sb.auth.signOut();
      LV.toast("Saiu.");
      await renderAuth();
    }

    async function saveCfg(){
      const payload = {
        id: 1,
        brand_name: (brandInput.value||"").trim() || "Barbearia Las Vegas",
        slot_interval_min: Number(slotInterval.value||10),
        min_advance_min: Number(minAdvance.value||60),
        cancel_limit_min: Number(cancelLimit.value||180),
        max_days_ahead: Number(maxDays.value||14),
        updated_at: new Date().toISOString()
      };
      const { error } = await sb.from("lv_config").upsert(payload, { onConflict:"id" });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Config salva!");
      await loadAll();
    }

    async function renderServices(){
      const { data } = await sb.from("lv_services").select("*").order("created_at",{ascending:true});
      svcList.innerHTML = "";
      for(const s of (data||[])){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${s.name}</div>
              <div class="muted small">ID: ${s.id} • ${s.duration_min}min • ${s.price==null?"—":"R$ "+Number(s.price).toFixed(2).replace(".",",")} • ${s.active? "Ativo":"Inativo"}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="toggle">${s.active? "Inativar":"Ativar"}</button>
              <button class="btn danger" data-act="del">Remover</button>
            </div>
          </div>
        `;
        div.querySelector('[data-act="toggle"]').onclick = async ()=>{
          await sb.from("lv_services").update({ active: !s.active }).eq("id", s.id);
          LV.toast("Atualizado.");
          await renderServices();
        };
        div.querySelector('[data-act="del"]').onclick = async ()=>{
          await sb.from("lv_services").delete().eq("id", s.id);
          LV.toast("Removido.");
          await renderServices();
        };
        svcList.appendChild(div);
      }
    }

    async function addService(){
      const name = (svcName.value||"").trim();
      const dur = Math.max(5, Number(svcDur.value||30));
      const priceRaw = (svcPrice.value||"").trim();
      const price = priceRaw==="" ? null : Math.max(0, Number(priceRaw));
      if(name.length < 2) return LV.toast("Nome inválido.");
      const id = LV.uid("SVC_");
      const { error } = await sb.from("lv_services").insert({ id, name, duration_min: dur, price, active:true });
      if(error) return LV.toast("Erro: " + error.message);
      svcName.value="";
      LV.toast("Serviço criado.");
      await renderServices();
    }

    async function renderBarbers(){
      const { data } = await sb.from("lv_barbers").select("*").order("created_at",{ascending:true});
      brbList.innerHTML = "";
      for(const b of (data||[])){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${b.name}</div>
              <div class="muted small">ID: ${b.id} • ${b.active? "Ativo":"Inativo"}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="toggle">${b.active? "Inativar":"Ativar"}</button>
            </div>
          </div>
        `;
        div.querySelector('[data-act="toggle"]').onclick = async ()=>{
          await sb.from("lv_barbers").update({ active: !b.active }).eq("id", b.id);
          LV.toast("Atualizado.");
          await renderBarbers();
        };
        brbList.appendChild(div);
      }
    }

    async function createBarberAuth(){
      const name = (brbName.value||"").trim();
      const em = (brbEmail.value||"").trim().toLowerCase();
      const pw = (brbPass.value||"").trim();
      if(name.length < 2) return LV.toast("Nome inválido.");
      if(!em.includes("@")) return LV.toast("Email inválido.");
      if(pw.length < 6) return LV.toast("Senha precisa ter 6+.");

      const barberId = LV.uid("BRB_");

      // chama Edge Function (precisa admin logado)
      const { data: { session } } = await sb.auth.getSession();
      if(!session) return LV.toast("Faça login.");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/create-staff-user`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({
          role: "barber",
          email: em,
          password: pw,
          barber_id: barberId,
          barber_name: name
        })
      });

      const out = await res.json();
      if(!res.ok) return LV.toast("Erro: " + (out.error || "falha"));
      LV.toast("Barbeiro criado! Envie email/senha pra ele.");
      brbName.value=""; brbEmail.value=""; brbPass.value="";
      await renderBarbers();
    }

    async function renderHours(){
      const { data } = await sb.from("lv_hours").select("*").order("weekday",{ascending:true});
      const map = new Map((data||[]).map(r=>[Number(r.weekday), r]));
      hoursGrid.innerHTML = "";

      for(let i=0;i<7;i++){
        const h = map.get(i) || { weekday:i, open:false, start_time:"09:00", end_time:"18:00" };
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="title">${dayNames[i]}</div>
              <div class="muted small">Abre? e horários</div>
            </div>
          </div>
          <div class="row">
            <label class="muted small" style="min-width:120px">
              <input type="checkbox" data-day="${i}" data-k="open" ${h.open?"checked":""}>
              Aberto
            </label>
            <div class="field" style="min-width:160px">
              <label>Início</label>
              <input class="input" type="time" data-day="${i}" data-k="start_time" value="${h.start_time}">
            </div>
            <div class="field" style="min-width:160px">
              <label>Fim</label>
              <input class="input" type="time" data-day="${i}" data-k="end_time" value="${h.end_time}">
            </div>
          </div>
        `;
        hoursGrid.appendChild(div);
      }
    }

    async function saveHoursNow(){
      const els = hoursGrid.querySelectorAll("[data-day]");
      const rows = [];
      for(const el of els){
        const day = Number(el.getAttribute("data-day"));
        const k = el.getAttribute("data-k");
        let r = rows.find(x=>x.weekday===day);
        if(!r){ r={weekday:day, open:false, start_time:"09:00", end_time:"18:00"}; rows.push(r); }
        if(k==="open") r.open = el.checked;
        else r[k] = el.value || r[k];
      }

      for(const r of rows){
        if(r.open){
          const a = LV.toMin(r.start_time), b = LV.toMin(r.end_time);
          if(!(a < b)) return LV.toast(`Horário inválido em ${dayNames[r.weekday]}`);
        }
      }

      const { error } = await sb.from("lv_hours").upsert(rows, { onConflict:"weekday" });
      if(error) return LV.toast("Erro: " + error.message);
      LV.toast("Horários salvos!");
      await renderHours();
    }

    loginBtn.onclick = login;
    password.addEventListener("keyup",(e)=>{ if(e.key==="Enter") login(); });
    logoutBtn.onclick = logout;

    saveConfig.onclick = saveCfg;
    addSvc.onclick = addService;
    addBarber.onclick = createBarberAuth;
    saveHours.onclick = saveHoursNow;

    sb.auth.onAuthStateChange(renderAuth);
    renderAuth();
  </script>
</body>
</html>
